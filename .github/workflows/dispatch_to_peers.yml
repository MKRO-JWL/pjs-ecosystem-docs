name: Dispatch MD Sync to Peers

on:
  push:
    branches: [main]
    paths:
      - 'SOFTWARE_ECOSYSTEM.md'

jobs:
  dispatch-sync:
    name: Notify all peer repos to sync
    runs-on: ubuntu-latest

    env:
      DISPATCH_EVENT: sync_requested

    steps:
      - name: List repos to notify
        id: repo-list
        run: |
          echo "REPOS<<EOF" >> $GITHUB_OUTPUT
          cat <<'REPOLIST' >> $GITHUB_OUTPUT
          MKRO-JWL/InfrastructureStack
          MKRO-JWL/DBUpdater
          MKRO-JWL/InventoryManager
          MKRO-JWL/MailBot
          REPOLIST
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Dispatch sync_requested to peers
        run: |
          while read -r repo; do
            echo "Dispatching to $repo"
            curl -X POST \
              -H "Authorization: token ${{ secrets.DISPATCH_PAT }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$repo/dispatches \
              -d "{\"event_type\":\"$DISPATCH_EVENT\"}"
          done <<< "${{ steps.repo-list.outputs.REPOS }}"
